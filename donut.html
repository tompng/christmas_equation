<script>
onload=function(){
  canvas=document.createElement('canvas');
  document.body.appendChild(canvas);
  g=canvas.getContext('2d');
  canvas.width=canvas.height=1024;
  var r=new Renderer();
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1;
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    var boko=0.5/(1+100*z*z);
    return donut+twist+boko;
  },[255,240,220]);

  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1;
    var deko=-0.2/(1+100*z*z);
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    return (donut+twist+deko)*(donut+twist+deko)+Math.pow((x-z)/4-1,12)-0.2;
  },[128,64,16]);
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    return (l-2)*(l-2)+10*z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/16;
  },[255,255,255]);
}
function Renderer(){
  this.depthbuf={};
}
Renderer.prototype.render=function(func,color){
  var values={};
  var SIZE=256;
  var cubes=[];
  var IN=2;
  var R=3.2;
  var size=SIZE/IN;
  for(var i=0;i<IN;i++)for(var j=0;j<IN;j++)for(var k=0;k<IN;k++){
    cubes.push({x:i*size,y:j*size,z:k*size})
  }
  while(size>1){
    function calc(x,y,z){
      var key=(x*SIZE+y)*SIZE+z;
      var val=values[key];
      if(val!==undefined)return val;
      val=func(R*(2*x/SIZE-1),R*(2*y/SIZE-1),R*(2*z/SIZE-1));
      return values[key]=val;
    }
    var subcubes=[];
    cubes.forEach(function(c){
      var neg=false;
      var pos=false;
      for(var i=0;i<=size;i++)for(var j=0;j<=size;j++){
        var val=calc(c.x+i,c.y+j,c.z);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+i,c.y+j,c.z+size);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x,c.y+i,c.z+j);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+size,c.y+i,c.z+j);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+j,c.y,c.z+i);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+j,c.y+size,c.z+i);
        neg=neg||val<0;pos=pos||val>0;
      }
      if(!neg||!pos)return;
      for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
        subcubes.push({x:c.x+i*size/2,y:c.y+j*size/2,z:c.z+k*size/2});  
      }
    })
    cubes=subcubes;
    size/=2;
    console.log(size,cubes.length)
  }
  var t=Math.PI/3;
  var cos=Math.cos(t),sin=Math.sin(t);
  var depthbuf=this.depthbuf;
  function depthplot(x,y,depth,color,light){
    if(x<0||x>=canvas.width||y<0||y>=canvas.height)return;
    var key=y*canvas.width+x;
    var currentDepth=depthbuf[key];
    if(currentDepth&&depth>currentDepth)return;
    depthbuf[key]=depth;
    g.fillStyle='rgb('+color.map(function(c){return Math.round(c*light)})+')'
    g.fillRect(x,canvas.height-y,1,1);
  }
  function plot(x,y,z){
    x=2*x/SIZE-1;
    y=2*y/SIZE-1;
    z=2*z/SIZE-1;
    var delta=R/SIZE/256;
    var f=func(R*x,R*y,R*z);
    fdx=func(R*x+delta,R*y,R*z)-f;
    fdy=func(R*x,R*y+delta,R*z)-f;
    fdz=func(R*x,R*y,R*z+delta)-f;
    var dr=Math.sqrt(fdx*fdx+fdy*fdy+fdz*fdz);
    var d={x:fdx/dr,y:fdy/dr,z:fdz/dr};
    var light=(2-(d.x+d.y+d.z)/Math.sqrt(3))/3;
    var p={
      x:x,
      y:(y*cos-sin*z),
      z:(z*cos+sin*y)
    };
    var L=3;
    var cx=(L-1)*p.x/(L+p.z);
    var cy=(L-1)*p.y/(L+p.z);

    for(var i=-2;i<=2;i++)for(var j=-2;j<=2;j++){
      depthplot(Math.round(canvas.width*(cx+1)/2)+i,Math.round(canvas.height*(cy+1)/2)+j,p.z,color,light)
    }
  }
  cubes.forEach(function(c){
    var cv=[[[],[]],[[],[]]];
    for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
      cv[i][j][k]=calc(c.x+i,c.y+j,c.z+k);
    }
    for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
      var a,b;
      if(i==0&&(a=cv[i][j][k])*(b=cv[1][j][k])<0){
        plot(c.x+a/(a-b),c.y+j,c.z+k)
      }if(j==0&&(a=cv[i][j][k])*(b=cv[i][1][k])<0){
        plot(c.x+i,c.y+a/(a-b),c.z+k)
      }if(k==0&&(a=cv[i][j][k])*(b=cv[i][j][1])<0){
        plot(c.x+i,c.y+j,c.z+a/(a-b))
      }
    }
  })
}
</script>

