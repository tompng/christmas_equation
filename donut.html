<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<style>
.hoge{position:relative;padding:1px;}
.piyo{position:absolute;left:4px;top:4px;}
</style>
<div class='hoge' style='background:rgb(255,224,160)'><span class='piyo'>donut</span>
\[
\bigl(\sqrt{x^2+y^2}-2\bigr)^2+z^2-1+\frac{3}{10}sin\bigl(5atan\frac{z}{\sqrt{x^2+y^2}-2}+8atan\frac{y}{x}\bigr)+\frac{1}{2(1+100z^2)}=0
\]
</div>
<div class='hoge' style='background:rgba(128,64,16,0.5)'><span class='piyo'>chocolate</span>
\[
\Bigl(\bigl(\sqrt{x^2+y^2}-2\bigr)^2+z^2-1+\frac{3}{10}sin\bigl(5atan\frac{z}{\sqrt{x^2+y^2}-2}+8atan\frac{y}{x}\bigr)-\frac{1}{5(1+100z^2)}\Bigr)^2+\bigl(\frac{x-z-5}{4}\bigr)^{12}-\frac{1}{5}=0
\]
</div>
<div class='hoge' style='background:rgb(240,240,240)'><span class='piyo'>cream</span>
\[
\bigl(\sqrt{x^2+y^2}-2\bigr)^2+10z^2-1+sin(7x-8y+9z)+sin(8x+9y-7z)+sin(-9x+7y-8z)=0
\]
</div>






<script>
onload=function(){
  canvas=document.createElement('canvas');
  canvas.style.width='100%'
  canvas.style.position='absolute'
  canvas.style.left=canvas.style.top=0
  document.body.appendChild(canvas);
  g=canvas.getContext('2d');
  canvas.width=canvas.height=1024;
  var r=new Renderer();
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/64;
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    var boko=0.5/(1+100*z*z);
    return donut+twist+boko;
  },[255,224,160]);
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/64;
    var deko=-0.2/(1+100*z*z);
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    return (donut+twist+deko)*(donut+twist+deko)+Math.pow((x-z-5)/4,12)-0.2;
  },[128,64,16]);
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    return (l-2)*(l-2)+10*z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/16;
  },[255,255,255]);
}
function Renderer(){
  this.depthbuf=[];
  this.imagedata=g.getImageData(0,0,canvas.width,canvas.height);
}
Renderer.prototype.render=function(func,color){
  var values={};
  var SIZE=256;
  var cubes=[];
  var IN=2;
  var R=3.2;
  var size=SIZE/IN;
  for(var i=0;i<IN;i++)for(var j=0;j<IN;j++)for(var k=0;k<IN;k++){
    cubes.push({x:i*size,y:j*size,z:k*size})
  }
  while(size>1){
    function calc(x,y,z){
      var key=(x*(SIZE+1)+y)*(SIZE+1)+z;
      var val=values[key];
      if(val!==undefined)return val;
      val=func(R*(2*x/SIZE-1),R*(2*y/SIZE-1),R*(2*z/SIZE-1));
      return values[key]=val;
    }
    var subcubes=[];
    cubes.forEach(function(c){
      var neg=false;
      var pos=false;
      for(var i=0;i<=size;i++)for(var j=0;j<=size;j++){
        var val=calc(c.x+i,c.y+j,c.z);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+i,c.y+j,c.z+size);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x,c.y+i,c.z+j);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+size,c.y+i,c.z+j);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+j,c.y,c.z+i);
        neg=neg||val<0;pos=pos||val>0;
        var val=calc(c.x+j,c.y+size,c.z+i);
        neg=neg||val<0;pos=pos||val>0;
      }
      if(!neg||!pos)return;
      for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
        subcubes.push({x:c.x+i*size/2,y:c.y+j*size/2,z:c.z+k*size/2});  
      }
    })
    cubes=subcubes;
    size/=2;
    console.log(size,cubes.length)
  }
  var t=Math.PI/3;
  var cos=Math.cos(t),sin=Math.sin(t);
  var depthbuf=this.depthbuf;
  var colorbuf=this.imagedata.data
  function depthplot(x,y,depth,color,light){
    if(x<0||x>=canvas.width||y<0||y>=canvas.height)return;
    var key=(canvas.height-y-1)*canvas.width+x;
    var currentDepth=depthbuf[key];
    if(currentDepth&&depth>currentDepth)return;
    depthbuf[key]=depth;
    for(var i=0;i<3;i++)colorbuf[4*key+i]=color[i]*light;
    colorbuf[4*key+3]=0xff;
  }
  function trans(p){
    var x=2*p.x/SIZE-1;
    var y=2*p.y/SIZE-1;
    var z=2*p.z/SIZE-1;
    var p={
      x:x,
      y:(y*cos-sin*z),
      z:(z*cos+sin*y)
    };
    var L=3;
    return {
      x:p.x,
      y:p.y,
      z:p.z,
      w:(L+p.z)/(L-1)
    }
  }
  function plotTriangle(a,b,c){
    var center={x:(a.x+b.x+c.x)/3,y:(a.y+b.y+c.y)/3,z:(a.z+b.z+c.z)/3};
    a=trans(a);
    b=trans(b);
    c=trans(c);
    var f=func(R*(2*center.x/SIZE-1),R*(2*center.y/SIZE-1),R*(2*center.z/SIZE-1));
    var d=1;
    var norm={
      x:func(R*(2*(center.x+d)/SIZE-1),R*(2*center.y/SIZE-1),R*(2*center.z/SIZE-1))-f,
      y:func(R*(2*center.x/SIZE-1),R*(2*(center.y+d)/SIZE-1),R*(2*center.z/SIZE-1))-f,
      z:func(R*(2*center.x/SIZE-1),R*(2*center.y/SIZE-1),R*(2*(center.z+d)/SIZE-1))-f,
    }
    var cr=Math.sqrt(norm.x*norm.x+norm.y*norm.y+norm.z*norm.z);
    var light=((norm.x+norm.y-norm.z)/cr/Math.sqrt(3)+2)/3;

    var ta={x:canvas.width*(a.x/a.w+1)/2,y:canvas.height*(a.y/a.w+1)/2};
    var tb={x:canvas.width*(b.x/b.w+1)/2,y:canvas.height*(b.y/b.w+1)/2};
    var tc={x:canvas.width*(c.x/c.w+1)/2,y:canvas.height*(c.y/c.w+1)/2};
    var xs=[ta.x,tb.x,tc.x],ys=[ta.y,tb.y,tc.y];
    var xmin=Math.min.apply(null,xs),xmax=Math.max.apply(null,xs);
    var ymin=Math.min.apply(null,ys),ymax=Math.max.apply(null,ys);
    for(var x=Math.ceil(xmin);x<=xmax;x++)for(var y=Math.ceil(ymin);y<=ymax;y++){
      var sx=tb.x-ta.x,sy=tb.y-ta.y;
      var tx=tc.x-ta.x,ty=tc.y-ta.y;
      var cx=x-ta.x,cy=y-ta.y;
      var D=sx*ty-tx*sy;
      var s=(cx*ty-tx*cy)/D;
      var t=(sx*cy-cx*sy)/D;
      if(0<=s&&0<=t&&s+t<=1)depthplot(x,y,(a.z+b.z+c.z),color,light);
    }
  }

  function plot(x,y,z){
    x=2*x/SIZE-1;
    y=2*y/SIZE-1;
    z=2*z/SIZE-1;
    var delta=R/SIZE/256;
    var f=func(R*x,R*y,R*z);
    fdx=func(R*x+delta,R*y,R*z)-f;
    fdy=func(R*x,R*y+delta,R*z)-f;
    fdz=func(R*x,R*y,R*z+delta)-f;
    var dr=Math.sqrt(fdx*fdx+fdy*fdy+fdz*fdz);
    var d={x:fdx/dr,y:fdy/dr,z:fdz/dr};
    var light=(2-(d.x+d.y+d.z)/Math.sqrt(3))/3;
    var p={
      x:x,
      y:(y*cos-sin*z),
      z:(z*cos+sin*y)
    };
    var L=3;
    var cx=(L-1)*p.x/(L+p.z);
    var cy=(L-1)*p.y/(L+p.z);

    depthplot(Math.round(canvas.width*(cx+1)/2),Math.round(canvas.height*(cy+1)/2),p.z,color,light)
    // for(var i=-1;i<=1;i++)for(var j=-1;j<=1;j++){
    //   depthplot(Math.round(canvas.width*(cx+1)/2)+i,Math.round(canvas.height*(cy+1)/2)+j,p.z,color,light)
    // }
  }
  cubes.forEach(function(c){
    var cv=[[[],[]],[[],[]]];
    for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
      cv[i][j][k]=calc(c.x+i,c.y+j,c.z+k);
    }
    var points=[];
    for(var i=0;i<2;i++)for(var j=0;j<2;j++)for(var k=0;k<2;k++){
      var a,b,p;
      if(i==0&&(a=cv[0][j][k])*(b=cv[1][j][k])<=0){
        p={x:c.x+a/(a-b),y:c.y+j,z:c.z+k};
        points.push([2+j,4+k,p]);
      }if(j==0&&(a=cv[i][0][k])*(b=cv[i][1][k])<=0){
        p={x:c.x+i,y:c.y+a/(a-b),z:c.z+k};
        points.push([i,4+k,p]);
      }if(k==0&&(a=cv[i][j][0])*(b=cv[i][j][1])<=0){
        p={x:c.x+i,y:c.y+j,z:c.z+a/(a-b)};
        points.push([i,2+j,p]);
      }
    }
    if(!points.length)return;
    var lines=[];
    var ps=points.map(function(a){return a});
    // var plen=points.length;
    while(points.length){
      var p=points.shift();
      var line=[p[2]];
      lines.push(line);
      var key=p[0];
      while(true){
        var p2=null;
        points.forEach(function(q){
          if(q[0]==key||q[1]==key)p2=q;
        });
        if(!p2)break;
        points=points.filter(function(q){return p2!=q})
        p=p2;
        line.push(p[2]);
        key=p[0]+p[1]-key;
      }
    }
    var tris=[];
    lines.forEach(function(line){
      for(var i=2;i<line.length;i++){
        tris.push([line[0],line[i-1],line[i]]);
      }
    });
    if(lines[0][0].z==4)console.log(c,cv)

    tris.forEach(function(tri){
      var pa=tri[0],pb=tri[1],pc=tri[2];
      plotTriangle(pa,pb,pc);
    })
  });
  g.putImageData(this.imagedata,0,0);
}
var hoge={};
</script>

