<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<script src='polygonizer.js'></script>
<style>
.hoge{position:relative;padding:1px;}
.piyo{position:absolute;left:4px;top:4px;}
</style>
<!--
<div class='hoge' style='background:rgb(255,224,160)'><span class='piyo'>donut</span>
\[
\bigl(\sqrt{x^2+y^2}-2\bigr)^2+z^2-1+\frac{3}{10}sin\bigl(5atan\frac{z}{\sqrt{x^2+y^2}-2}+8atan\frac{y}{x}\bigr)+\frac{1}{2(1+100z^2)}=0
\]
</div>
<div class='hoge' style='background:rgba(128,64,16,0.5)'><span class='piyo'>chocolate</span>
\[
\Bigl(\bigl(\sqrt{x^2+y^2}-2\bigr)^2+z^2-1+\frac{3}{10}sin\bigl(5atan\frac{z}{\sqrt{x^2+y^2}-2}+8atan\frac{y}{x}\bigr)-\frac{1}{5(1+100z^2)}\Bigr)^2+\bigl(\frac{x-z-5}{4}\bigr)^{12}-\frac{1}{5}=0
\]
</div>
<div class='hoge' style='background:rgb(240,240,240)'><span class='piyo'>cream</span>
\[
\bigl(\sqrt{x^2+y^2}-2\bigr)^2+10z^2-1+sin(7x-8y+9z)+sin(8x+9y-7z)+sin(-9x+7y-8z)=0
\]
</div>

\[
w=  x\bigl(1-\frac{1.25}{1+8(y-0.9)^2}+\frac{1}{1+16(y-0.8)^2}\bigr)\\
x^2+y^2+32atan^2\Bigl(|z|-\frac{1}{2}+\frac{w^2}{2}+\frac{y^2}{4}+\frac{y-1}{32}cos\bigl(32atan\frac{w}{y-1}\bigr)+\frac{y-1}{8}\Bigr)=1

\]

-->
<script>
onload=function(){
  canvas=document.createElement('canvas');
  canvas.style.width='100%'
  canvas.style.position='absolute'
  canvas.style.left=canvas.style.top=0
  document.body.appendChild(canvas);
  g=canvas.getContext('2d');
  canvas.width=canvas.height=2048;
  var r=new Renderer();
  function starfunc(x,y,z){
    y-=0.46;
    x*=4;y*=4;z*=3;
    var l=Math.sqrt(0.01+x*x+y*y)-0.1;
    var th=Math.atan2(y,x);
    return 4*Math.sqrt(0.01+z*z)+l*(1-0.2*Math.asin(0.98*Math.sin(5*th)))-1
  }
  // r.render(starfunc,[255,255,128]);
  function decofunc(x,y,z){
    var R=1.5;
    x*=R;y*=R;z*=R;
    y+=0.5;
    y+=Math.sin(3*x+4*y+5*z)/8;
    var r=(1-y)/2+0.1;
    return Math.pow(Math.sin(6*y)/6,2)+Math.pow(Math.sqrt(x*x+z*z)-r,2)-0.001*(1-y*y)
  }
  // r.render(decofunc, [255,255,255])
  function treefunc(x,y,z){
    var R=1.5;
    x*=R;y*=R;z*=R
    y+=0.5
    var l2=x*x+z*z,l=Math.sqrt(l2);

    var s=Math.atan2(z,x);
    var t=1-y-Math.sqrt(l2)/2;
    var deko=Math.pow(Math.sin(2*s+3*3*t)*Math.sin(3*s-3*2*t),2)/(1+Math.exp(10*(t-1.45)))
    l-=deko*(1-y)/8;
    y-=deko*(1-y)/8;
    var a=4*l/(1-y+Math.sqrt(0.01+(1-y)*(1-y)))*Math.sqrt(1-y*y+Math.sqrt(0.01+(1-y*y)*(1-y*y)))
    return y*y+a*a-1-10/(1+Math.pow(40*l2,10)+Math.pow((y+1)*10,10));
  }

  r.render(function(x,y,z){
    var tree=treefunc(x,y,z);
    var star=starfunc(x,y,z);
    var deco=decofunc(x,y,z);
    return (Math.atan(tree)*Math.atan(star)-0.01)*deco
  },[0xff,0xff,0xff]);


return
  r.render(function(x,y,z){
    var _=y;y=x;x=_;
    z=Math.abs(z);
    z-=0.5;
    x*=1-1.25/(1+8*(y-0.9)*(y-0.9))+1/(1+16*(y-0.8)*(y-0.8));
    var th=Math.atan2(x,y-1);
    var zz=z+x*x/2+y*y/4+(y-1)*Math.cos(32*th)/32+(y-1)/8;
    return x*x+y*y+32*Math.atan(zz)*Math.atan(zz)-1
  },[0xff,0xdd,0xee])
  return;
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/64;
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    var boko=0.5/(1+100*z*z);
    return donut+twist+boko;
  },[255,224,160]);
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    var donut=(l-2)*(l-2)+z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/64;
    var deko=-0.2/(1+100*z*z);
    var twist=0.3*Math.sin(5*Math.atan2(z,l-2)+8*Math.atan2(y,x));
    return (donut+twist+deko)*(donut+twist+deko)+Math.pow((x-z-5)/4,12)-0.2;
  },[128,64,16]);
  r.render(function(x,y,z){
    var l=Math.sqrt(x*x+y*y);
    return (l-2)*(l-2)+10*z*z-1+(Math.sin(7*x-8*y+9*z)+Math.sin(8*x+9*y-7*z)+Math.sin(-9*x+7*y+8*z))/16;
  },[255,255,255]);
}
function Renderer(){
  this.depthbuf=[];
  this.imagedata=g.getImageData(0,0,canvas.width,canvas.height);
}

Renderer.prototype.render=function(func,color){
  var values={};
  var SIZE=512;
  var R=1.2;
  var t=-0*30*Math.PI/180;
  var cos=Math.cos(t),sin=Math.sin(t);
  var depthbuf=this.depthbuf;
  var colorbuf=this.imagedata.data
  var triangles=Polygonizer.generate(func,SIZE,R);
  triangles.forEach(function(tri){
    var pa=tri[0],pb=tri[1],pc=tri[2];
    plotTriangle(pa,pb,pc);
  })
  function depthplot(x,y,depth,color,light){
    if(x<0||x>=canvas.width||y<0||y>=canvas.height)return;
    var key=(canvas.height-y-1)*canvas.width+x;
    var currentDepth=depthbuf[key];
    if(currentDepth&&depth>currentDepth)return;
    depthbuf[key]=depth;
    for(var i=0;i<3;i++)colorbuf[4*key+i]=color[i]*light;
    colorbuf[4*key+3]=0xff;
  }
  function trans(p){
    var x=2*p.x/SIZE-1;
    var y=2*p.y/SIZE-1;
    var z=2*p.z/SIZE-1;
    var p={
      x:x,
      y:(y*cos-sin*z),
      z:(z*cos+sin*y)
    };
    var L=3;
    return {
      x:p.x,
      y:p.y,
      z:p.z,
      w:(L+p.z)/(L-1)*0.7
    }
  }
  function plotTriangle(a,b,c){
    var center={x:(a.x+b.x+c.x)/3,y:(a.y+b.y+c.y)/3,z:(a.z+b.z+c.z)/3};
    a=trans(a);
    b=trans(b);
    c=trans(c);
    var f=func(R*(2*center.x/SIZE-1),R*(2*center.y/SIZE-1),R*(2*center.z/SIZE-1));
    var d=1;
    var norm={
      x:func(R*(2*(center.x+d)/SIZE-1),R*(2*center.y/SIZE-1),R*(2*center.z/SIZE-1))-f,
      y:func(R*(2*center.x/SIZE-1),R*(2*(center.y+d)/SIZE-1),R*(2*center.z/SIZE-1))-f,
      z:func(R*(2*center.x/SIZE-1),R*(2*center.y/SIZE-1),R*(2*(center.z+d)/SIZE-1))-f,
    }
    var cr=Math.sqrt(norm.x*norm.x+norm.y*norm.y+norm.z*norm.z);
    var light=((norm.x+norm.y-norm.z)/cr/Math.sqrt(3)+2)/3;

    var ta={x:canvas.width*(a.x/a.w+1)/2,y:canvas.height*(a.y/a.w+1)/2};
    var tb={x:canvas.width*(b.x/b.w+1)/2,y:canvas.height*(b.y/b.w+1)/2};
    var tc={x:canvas.width*(c.x/c.w+1)/2,y:canvas.height*(c.y/c.w+1)/2};
    var xs=[ta.x,tb.x,tc.x],ys=[ta.y,tb.y,tc.y];
    var xmin=Math.min.apply(null,xs),xmax=Math.max.apply(null,xs);
    var ymin=Math.min.apply(null,ys),ymax=Math.max.apply(null,ys);
    for(var x=Math.ceil(xmin);x<=xmax;x++)for(var y=Math.ceil(ymin);y<=ymax;y++){
      var sx=tb.x-ta.x,sy=tb.y-ta.y;
      var tx=tc.x-ta.x,ty=tc.y-ta.y;
      var cx=x-ta.x,cy=y-ta.y;
      var D=sx*ty-tx*sy;
      var s=(cx*ty-tx*cy)/D;
      var t=(sx*cy-cx*sy)/D;
      if(0<=s&&0<=t&&s+t<=1)depthplot(x,y,(a.z+b.z+c.z),color,light);
    }
  }

  function plot(x,y,z){
    x=2*x/SIZE-1;
    y=2*y/SIZE-1;
    z=2*z/SIZE-1;
    var delta=R/SIZE/256;
    var f=func(R*x,R*y,R*z);
    fdx=func(R*x+delta,R*y,R*z)-f;
    fdy=func(R*x,R*y+delta,R*z)-f;
    fdz=func(R*x,R*y,R*z+delta)-f;
    var dr=Math.sqrt(fdx*fdx+fdy*fdy+fdz*fdz);
    var d={x:fdx/dr,y:fdy/dr,z:fdz/dr};
    var light=(2-(d.x+d.y+d.z)/Math.sqrt(3))/3;
    var p={
      x:x,
      y:(y*cos-sin*z),
      z:(z*cos+sin*y)
    };
    var L=3;
    var cx=(L-1)*p.x/(L+p.z);
    var cy=(L-1)*p.y/(L+p.z);
    depthplot(Math.round(canvas.width*(cx+1)/2),Math.round(canvas.height*(cy+1)/2),p.z,color,light)
  }
  g.putImageData(this.imagedata,0,0);
}
var hoge={};
</script>

